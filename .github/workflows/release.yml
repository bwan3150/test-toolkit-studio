name: Build Release

# è§¦å‘æ¡ä»¶: æ‰‹åŠ¨è§¦å‘æˆ–æ¨é€ tag
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 0.4.2)'
        required: false
        default: ''
      build_mac:
        description: 'æ„å»º macOS ç‰ˆæœ¬'
        type: boolean
        default: true
      build_windows:
        description: 'æ„å»º Windows ç‰ˆæœ¬'
        type: boolean
        default: true
  push:
    tags:
      - 'v*.*.*'

# æˆäºˆ GitHub Actions å†™å…¥æƒé™ä»¥ä¾¿æäº¤ package.json æ›´æ–°
permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  RUST_VERSION: 'stable'

jobs:
  # å‡†å¤‡å·¥ä½œ: è·å–ç‰ˆæœ¬ä¿¡æ¯å¹¶æ›´æ–° package.json
  prepare:
    name: å‡†å¤‡æ„å»ºä¿¡æ¯
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      date: ${{ steps.version.outputs.date }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            TAG=${GITHUB_REF#refs/tags/}
          elif [[ "${{ github.event.inputs.version }}" != "" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG="v$VERSION"
          else
            VERSION=$(grep '"version"' package.json | head -1 | sed -E 's/.*"version": *"([^"]+)".*/\1/')
            TAG="manual-$VERSION"
          fi

          # ç¡®ä¿ VERSION ä¸åŒ…å« 'v' å‰ç¼€ï¼ˆå®‰å…¨æ£€æŸ¥ï¼‰
          VERSION=${VERSION#v}

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ ç‰ˆæœ¬: $VERSION"
          echo "ğŸ·ï¸  æ ‡ç­¾: $TAG"

  # macOS æ„å»º
  build-macos:
    name: æ„å»º macOS åº”ç”¨
    needs: prepare
    runs-on: macos-latest
    environment: aws-production  # ä½¿ç”¨ Environment Secrets
    env:
      BUILD_VERSION: ${{ needs.prepare.outputs.version }}
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.build_mac == 'true')
    steps:
      - name: æ£€å‡ºä»£ç ï¼ˆè·³è¿‡ LFS å¤§æ–‡ä»¶ï¼‰
        uses: actions/checkout@v4
        with:
          lfs: false  # ä¸ä¸‹è½½ LFS å¤§æ–‡ä»¶ï¼Œä»æºä»£ç é‡æ–°æ„å»º

      - name: æ›´æ–° package.json ç‰ˆæœ¬å·ï¼ˆä»…æœ¬åœ°ï¼‰
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          CURRENT_VERSION=$(grep '"version"' package.json | head -1 | sed -E 's/.*"version": *"([^"]+)".*/\1/')

          if [[ "$CURRENT_VERSION" != "$VERSION" ]]; then
            echo "æœ¬åœ°æ›´æ–° package.json: $CURRENT_VERSION â†’ $VERSION"
            sed -i '' -E "s/\"version\": *\"[^\"]+\"/\"version\": \"$VERSION\"/" package.json
          else
            echo "package.json ç‰ˆæœ¬å·²æ˜¯æœ€æ–°: $VERSION"
          fi

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # è®¾ç½® Rust ç¯å¢ƒ
      - name: è®¾ç½® Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      # ç¼“å­˜ Cargo
      - name: ç¼“å­˜ Cargo ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            toolkit-engine/target
            tester-ai/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # è®¾ç½® Python ç¯å¢ƒ (ç”¨äº opencv-matcher)
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # å®‰è£… uv (Python åŒ…ç®¡ç†å™¨)
      - name: å®‰è£… uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      # å®‰è£… Node.js ä¾èµ–
      - name: å®‰è£… Node.js ä¾èµ–
        run: |
          npm install
          npm audit fix || true

      # æ„å»º toolkit-engine (TKE)
      - name: æ„å»º Toolkit Engine (Rust)
        working-directory: toolkit-engine
        run: |
          echo "=== æ„å»º TKE for macOS ==="
          echo "ç‰ˆæœ¬å·: $BUILD_VERSION"

          # æ„å»ºï¼ˆbuild.rs ä¼šè‡ªåŠ¨ä» BUILD_VERSION ç¯å¢ƒå˜é‡è¯»å–ç‰ˆæœ¬ï¼‰
          cargo build --release

          # å¤åˆ¶åˆ°èµ„æºç›®å½•
          mkdir -p ../resources/darwin/toolkit-engine
          cp target/release/tke ../resources/darwin/toolkit-engine/tke
          chmod +x ../resources/darwin/toolkit-engine/tke

          echo "âœ… TKE æ„å»ºå®Œæˆ"
          ls -lh ../resources/darwin/toolkit-engine/tke

      # æ„å»º opencv-matcher (Python)
      - name: æ„å»º OpenCV Matcher (Python)
        working-directory: opencv-matcher
        run: |
          echo "=== æ„å»º tke-opencv for macOS ==="
          echo "ç‰ˆæœ¬å·: $BUILD_VERSION"

          # ç”Ÿæˆ _version.py æ–‡ä»¶ï¼ˆæ‰“åŒ…æ—¶åµŒå…¥ç‰ˆæœ¬å·ï¼‰
          echo "# è‡ªåŠ¨ç”Ÿæˆçš„ç‰ˆæœ¬æ–‡ä»¶ - è¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹" > _version.py
          echo "__version__ = '$BUILD_VERSION'" >> _version.py
          echo "âœ“ å·²ç”Ÿæˆ _version.py: $BUILD_VERSION"

          # åŒæ­¥ä¾èµ–å¹¶æ‰“åŒ…
          uv sync --group dev
          .venv/bin/pyinstaller \
            --onefile \
            --name tke-opencv \
            --clean \
            --noconfirm \
            opencv_matcher.py

          # æ¸…ç†ç”Ÿæˆçš„ _version.py
          rm -f _version.py

          # å¤åˆ¶åˆ°èµ„æºç›®å½•
          mkdir -p ../resources/darwin/toolkit-engine
          cp dist/tke-opencv ../resources/darwin/toolkit-engine/tke-opencv
          chmod +x ../resources/darwin/toolkit-engine/tke-opencv

          echo "âœ… tke-opencv æ„å»ºå®Œæˆ"
          ls -lh ../resources/darwin/toolkit-engine/tke-opencv

      # æ„å»º tester-ai (Rust)
      - name: æ„å»º AI Tester (Rust)
        working-directory: tester-ai
        run: |
          echo "=== æ„å»º tester-ai for macOS ==="
          echo "ç‰ˆæœ¬å·: $BUILD_VERSION"

          # æ„å»ºï¼ˆbuild.rs ä¼šè‡ªåŠ¨ä» BUILD_VERSION ç¯å¢ƒå˜é‡è¯»å–ç‰ˆæœ¬ï¼‰
          cargo build --release

          # å¤åˆ¶åˆ°èµ„æºç›®å½•
          mkdir -p ../resources/darwin/tester-ai
          cp target/release/tester-ai ../resources/darwin/tester-ai/tester-ai
          chmod +x ../resources/darwin/tester-ai/tester-ai

          echo "âœ… tester-ai æ„å»ºå®Œæˆ"
          ls -lh ../resources/darwin/tester-ai/tester-ai

      # éªŒè¯æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶
      - name: éªŒè¯æ„å»ºäº§ç‰©
        run: |
          set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
          echo "=== éªŒè¯æ„å»ºäº§ç‰© ==="

          echo "ğŸ“¦ TKE:"
          resources/darwin/toolkit-engine/tke --version

          echo "ğŸ“¦ tke-opencv:"
          resources/darwin/toolkit-engine/tke-opencv --version

          echo "ğŸ“¦ tester-ai:"
          resources/darwin/tester-ai/tester-ai --version || resources/darwin/tester-ai/tester-ai --help

          echo "âœ… æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶éªŒè¯å®Œæˆ"

      # é…ç½® macOS ä»£ç ç­¾å
      - name: é…ç½® macOS ä»£ç ç­¾å
        env:
          APPLE_CERT_BASE64: ${{ secrets.APPLE_CERT_BASE64 }}
          APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERT_PASSWORD }}
        run: |
          echo "=== é…ç½® macOS ä»£ç ç­¾å ==="

          # åˆ›å»ºä¸´æ—¶ keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # åˆ›å»ºå¹¶è§£é” keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # å¯¼å…¥è¯ä¹¦
          CERT_PATH=$RUNNER_TEMP/certificate.p12
          echo "$APPLE_CERT_BASE64" | base64 --decode > "$CERT_PATH"
          security import "$CERT_PATH" -P "$APPLE_CERT_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"

          # è®¾ç½®ä¸ºé»˜è®¤ keychain å¹¶å…è®¸ codesign ä½¿ç”¨
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "âœ… ä»£ç ç­¾åé…ç½®å®Œæˆ"
          security find-identity -v -p codesigning

      # æ„å»º Electron åº”ç”¨ (macOS)
      - name: æ„å»º Electron åº”ç”¨
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-southeast-2
        run: |
          echo "=== æ„å»º Electron åº”ç”¨ for macOS ==="
          # electron-builder åªåœ¨æ£€æµ‹åˆ° git tag æ—¶æ‰ä¼šä¸Šä¼ åˆ° S3
          npx electron-builder --mac

          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "âœ… Electron åº”ç”¨æ„å»ºå®Œæˆå¹¶å·²ä¸Šä¼ åˆ° S3"
          else
            echo "âœ… Electron åº”ç”¨æ„å»ºå®Œæˆï¼ˆæœªä¸Šä¼ åˆ° S3ï¼Œä»…æµ‹è¯•æ„å»ºï¼‰"
          fi
          ls -lh dist/

      # æ¸…ç† keychain
      - name: æ¸…ç† keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true

      # é‡å‘½ååº”ç”¨
      - name: é‡å‘½ååº”ç”¨
        run: |
          mkdir -p release

          # æŸ¥æ‰¾ç”Ÿæˆçš„ DMG æˆ– APP
          if ls dist/*.dmg 1> /dev/null 2>&1; then
            DMG_FILE=$(ls dist/*.dmg | head -n 1)
            cp "$DMG_FILE" "release/Toolkit Studio ${{ needs.prepare.outputs.tag }} macOS.dmg"
            echo "âœ… æ‰¾åˆ° DMG: $DMG_FILE"
          elif ls dist/mac/*.app 1> /dev/null 2>&1; then
            APP_FILE=$(ls -d dist/mac/*.app | head -n 1)
            # å‹ç¼©ä¸º zip
            cd dist/mac
            zip -r "../../release/Toolkit Studio ${{ needs.prepare.outputs.tag }} macOS.zip" *.app
            cd ../..
            echo "âœ… æ‰¾åˆ° APPï¼Œå·²å‹ç¼©ä¸º ZIP"
          else
            echo "âŒ æœªæ‰¾åˆ° DMG æˆ– APP æ–‡ä»¶"
            ls -R dist/
            exit 1
          fi

      # ä¸Šä¼ åˆ° Artifacts
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: release/*
          retention-days: 30

  # Windows æ„å»º
  build-windows:
    name: æ„å»º Windows åº”ç”¨
    needs: prepare
    runs-on: windows-latest
    environment: aws-production  # ä½¿ç”¨ Environment Secrets
    env:
      BUILD_VERSION: ${{ needs.prepare.outputs.version }}
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.build_windows == 'true')
    steps:
      - name: æ£€å‡ºä»£ç ï¼ˆè·³è¿‡ LFS å¤§æ–‡ä»¶ï¼‰
        uses: actions/checkout@v4
        with:
          lfs: false  # ä¸ä¸‹è½½ LFS å¤§æ–‡ä»¶ï¼Œä»æºä»£ç é‡æ–°æ„å»º

      - name: æ›´æ–° package.json ç‰ˆæœ¬å·ï¼ˆä»…æœ¬åœ°ï¼‰
        shell: pwsh
        run: |
          $VERSION = "${{ needs.prepare.outputs.version }}"
          $content = Get-Content package.json -Raw
          $currentVersion = ($content | Select-String -Pattern '"version"\s*:\s*"([^"]+)"').Matches.Groups[1].Value

          if ($currentVersion -ne $VERSION) {
            Write-Host "æœ¬åœ°æ›´æ–° package.json: $currentVersion â†’ $VERSION"
            $content = $content -replace '"version"\s*:\s*"[^"]+"', """version"": ""$VERSION"""
            $content | Set-Content package.json -NoNewline
          } else {
            Write-Host "package.json ç‰ˆæœ¬å·²æ˜¯æœ€æ–°: $VERSION"
          }

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # è®¾ç½® Rust ç¯å¢ƒ
      - name: è®¾ç½® Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      # ç¼“å­˜ Cargo
      - name: ç¼“å­˜ Cargo ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            toolkit-engine/target
            tester-ai/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # è®¾ç½® Python ç¯å¢ƒ
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # å®‰è£… uv (Windows) - ä½¿ç”¨ pip å®‰è£…æ›´å¯é 
      - name: å®‰è£… uv
        shell: cmd
        run: |
          pip install uv
          uv --version

      # å®‰è£… Node.js ä¾èµ–
      - name: å®‰è£… Node.js ä¾èµ–
        shell: cmd
        run: |
          npm install
          npm audit fix

      # æ„å»º toolkit-engine (TKE)
      - name: æ„å»º Toolkit Engine (Rust)
        shell: cmd
        working-directory: toolkit-engine
        run: |
          echo === æ„å»º TKE for Windows ===
          echo ç‰ˆæœ¬å·: %BUILD_VERSION%

          REM æ„å»ºï¼ˆbuild.rs ä¼šè‡ªåŠ¨ä» BUILD_VERSION ç¯å¢ƒå˜é‡è¯»å–ç‰ˆæœ¬ï¼‰
          cargo build --release

          REM åˆ›å»ºç›®æ ‡ç›®å½•
          if not exist "..\resources\win32\toolkit-engine" mkdir "..\resources\win32\toolkit-engine"

          REM å¤åˆ¶åˆ°èµ„æºç›®å½•
          copy /Y "target\release\tke.exe" "..\resources\win32\toolkit-engine\tke.exe"

          echo âœ… TKE æ„å»ºå®Œæˆ
          dir "..\resources\win32\toolkit-engine\tke.exe"

      # æ„å»º opencv-matcher (Python)
      - name: æ„å»º OpenCV Matcher (Python)
        shell: cmd
        working-directory: opencv-matcher
        run: |
          echo === æ„å»º tke-opencv for Windows ===
          echo ç‰ˆæœ¬å·: %BUILD_VERSION%

          REM ç”Ÿæˆ _version.py æ–‡ä»¶ï¼ˆæ‰“åŒ…æ—¶åµŒå…¥ç‰ˆæœ¬å·ï¼‰
          echo # è‡ªåŠ¨ç”Ÿæˆçš„ç‰ˆæœ¬æ–‡ä»¶ - è¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹ > _version.py
          echo __version__ = '%BUILD_VERSION%' >> _version.py
          echo å·²ç”Ÿæˆ _version.py: %BUILD_VERSION%

          REM åŒæ­¥ä¾èµ–
          uv sync --group dev

          REM æ‰“åŒ…
          .venv\Scripts\pyinstaller --onefile --name tke-opencv --clean --noconfirm opencv_matcher.py

          REM æ¸…ç†ç”Ÿæˆçš„ _version.py
          if exist "_version.py" del /f /q "_version.py"

          REM æ£€æŸ¥æ‰“åŒ…æ˜¯å¦æˆåŠŸ
          if not exist "dist\tke-opencv.exe" (
            echo âŒ æ‰“åŒ…å¤±è´¥ï¼šæœªæ‰¾åˆ° dist\tke-opencv.exe
            exit /b 1
          )

          REM åˆ›å»ºç›®æ ‡ç›®å½•
          if not exist "..\resources\win32\toolkit-engine" mkdir "..\resources\win32\toolkit-engine"

          REM å¤åˆ¶åˆ°èµ„æºç›®å½•
          copy /Y "dist\tke-opencv.exe" "..\resources\win32\toolkit-engine\tke-opencv.exe"

          echo âœ… tke-opencv æ„å»ºå®Œæˆ
          dir "..\resources\win32\toolkit-engine\tke-opencv.exe"

      # æ„å»º tester-ai (Rust)
      - name: æ„å»º AI Tester (Rust)
        shell: cmd
        working-directory: tester-ai
        run: |
          echo === æ„å»º tester-ai for Windows ===
          echo ç‰ˆæœ¬å·: %BUILD_VERSION%

          REM æ„å»ºï¼ˆbuild.rs ä¼šè‡ªåŠ¨ä» BUILD_VERSION ç¯å¢ƒå˜é‡è¯»å–ç‰ˆæœ¬ï¼‰
          cargo build --release

          REM åˆ›å»ºç›®æ ‡ç›®å½•
          if not exist "..\resources\win32\tester-ai" mkdir "..\resources\win32\tester-ai"

          REM å¤åˆ¶åˆ°èµ„æºç›®å½•
          copy /Y "target\release\tester-ai.exe" "..\resources\win32\tester-ai\tester-ai.exe"

          echo âœ… tester-ai æ„å»ºå®Œæˆ
          dir "..\resources\win32\tester-ai\tester-ai.exe"

      # éªŒè¯æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶
      - name: éªŒè¯æ„å»ºäº§ç‰©
        shell: cmd
        run: |
          echo === éªŒè¯æ„å»ºäº§ç‰© ===

          echo ğŸ“¦ TKE:
          resources\win32\toolkit-engine\tke.exe --version
          if errorlevel 1 exit /b 1

          echo ğŸ“¦ tke-opencv:
          resources\win32\toolkit-engine\tke-opencv.exe --version
          if errorlevel 1 exit /b 1

          echo ğŸ“¦ tester-ai:
          resources\win32\tester-ai\tester-ai.exe --version
          if errorlevel 1 exit /b 1

          echo âœ… æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶éªŒè¯å®Œæˆ

      # æ„å»º Electron åº”ç”¨ (Windows)
      - name: æ„å»º Electron åº”ç”¨
        shell: pwsh
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-southeast-2
        run: |
          Write-Host "=== æ„å»º Electron åº”ç”¨ for Windows ==="
          # electron-builder åªåœ¨æ£€æµ‹åˆ° git tag æ—¶æ‰ä¼šä¸Šä¼ åˆ° S3
          npx electron-builder --win

          if ("${{ github.event_name }}" -eq "push") {
            Write-Host "âœ… Electron åº”ç”¨æ„å»ºå®Œæˆå¹¶å·²ä¸Šä¼ åˆ° S3"
          } else {
            Write-Host "âœ… Electron åº”ç”¨æ„å»ºå®Œæˆï¼ˆæœªä¸Šä¼ åˆ° S3ï¼Œä»…æµ‹è¯•æ„å»ºï¼‰"
          }
          Get-ChildItem dist\

      # é‡å‘½ååº”ç”¨
      - name: é‡å‘½ååº”ç”¨
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path release

          # æŸ¥æ‰¾ç”Ÿæˆçš„å®‰è£…åŒ…
          $exeFile = Get-ChildItem -Path dist -Filter "*.exe" -Recurse | Select-Object -First 1
          if ($exeFile) {
            Copy-Item -Path $exeFile.FullName -Destination "release/Toolkit Studio ${{ needs.prepare.outputs.tag }} Windows.exe"
            Write-Host "âœ… æ‰¾åˆ°å®‰è£…åŒ…: $($exeFile.FullName)"
          } else {
            Write-Host "âŒ æœªæ‰¾åˆ°å®‰è£…åŒ…"
            Get-ChildItem -Path dist -Recurse
            exit 1
          }

      # ä¸Šä¼ åˆ° Artifacts
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-app
          path: release/*
          retention-days: 30

  # åˆ›å»º GitHub Releaseï¼ˆä»…åœ¨ tag è§¦å‘æ—¶ï¼‰
  create-release:
    name: åˆ›å»º GitHub Release
    needs: [prepare, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' &&
      (needs.build-macos.result == 'success' || needs.build-windows.result == 'success')
    permissions:
      contents: write
    steps:
      - name: ä¸‹è½½æ‰€æœ‰ Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
        run: |
          echo "ğŸ“¦ æ‰€æœ‰æ„å»ºäº§ç‰©:"
          find artifacts -type f -exec ls -lh {} \;

      - name: åˆ›å»º Release è‰ç¨¿
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: Toolkit Studio ${{ needs.prepare.outputs.tag }}
          generate_release_notes: true
          files: artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # åç»­å¤„ç†ï¼šä¸Šä¼  Release Notes å’Œæ›´æ–° package.json
  post-build:
    name: ä¸Šä¼  Release Notes å’Œæ›´æ–°ç‰ˆæœ¬å·
    needs: [prepare, build-macos, build-windows]
    runs-on: ubuntu-latest
    environment: aws-production
    if: |
      needs.build-macos.result == 'success' || needs.build-windows.result == 'success'
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼  Release Notes åˆ° S3
        if: github.event_name == 'push'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-southeast-2
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"

          if [ -f "build/RELEASE_NOTES.md" ]; then
            echo "ä¸Šä¼  RELEASE_NOTES.md åˆ° S3..."
            aws s3 cp build/RELEASE_NOTES.md s3://toolkit-studio-updates/release-notes/${VERSION}.md --content-type "text/markdown"
            echo "âœ… Release notes å·²ä¸Šä¼ : s3://toolkit-studio-updates/release-notes/${VERSION}.md"
          else
            echo "âš ï¸  æœªæ‰¾åˆ° build/RELEASE_NOTES.mdï¼Œè·³è¿‡ä¸Šä¼ "
          fi

      - name: æ›´æ–° package.json ç‰ˆæœ¬å·
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"

          # è¯»å–å½“å‰ package.json ä¸­çš„ç‰ˆæœ¬
          CURRENT_VERSION=$(grep '"version"' package.json | head -1 | sed -E 's/.*"version": *"([^"]+)".*/\1/')

          if [[ "$CURRENT_VERSION" != "$VERSION" ]]; then
            echo "æ›´æ–° package.json: $CURRENT_VERSION â†’ $VERSION"
            sed -i -E "s/\"version\": *\"[^\"]+\"/\"version\": \"$VERSION\"/" package.json

            # é…ç½® git
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            # æäº¤æ›´æ”¹å¹¶æ¨é€åˆ° main åˆ†æ”¯
            git add package.json
            git commit -m "Update: version tag $VERSION by GitHub Action"
            git push

            echo "âœ… package.json å·²æ›´æ–°å¹¶æäº¤åˆ° main åˆ†æ”¯"
          else
            echo "âœ… package.json ç‰ˆæœ¬å·²æ˜¯æœ€æ–° ($VERSION)ï¼Œæ— éœ€æ›´æ–°"
          fi
