<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Toolkit Studio</title>
    <link rel="stylesheet" href="../styles/common.css" />
    <link rel="stylesheet" href="../styles/platform.css" />
    <link rel="stylesheet" href="../styles/main.css" />
    <link rel="stylesheet" href="../styles/components/bottom-panel.css" />
    <link rel="stylesheet" href="../styles/pages/project.css" />
    <link rel="stylesheet" href="../styles/pages/testcase.css" />
    <link rel="stylesheet" href="../styles/pages/device.css" />
    <link rel="stylesheet" href="../styles/pages/log.css" />
    <link rel="stylesheet" href="../styles/pages/report.css" />
    <link rel="stylesheet" href="../styles/pages/settings.css" />
    <link rel="stylesheet" href="../styles/codejar-editor.css" />
    <link rel="stylesheet" href="../styles/block-mode.css" />
  </head>
  <body>
    <script>
      // Set platform class for CSS
      document.body.classList.add("platform-" + process.platform);
    </script>

    <!-- Title bar area for dragging -->
    <div class="titlebar-area">
      <!-- 自定义标题栏 - macOS 风格三色灯 -->
      <div class="custom-titlebar">
        <div class="titlebar-controls-left">
          <!-- 红色 - 关闭 -->
          <button class="titlebar-dot close-dot" id="close-btn" title="关闭">
            <svg width="6" height="6" viewBox="0 0 6 6" class="dot-icon">
              <path d="M1,1 L5,5 M5,1 L1,5" stroke="currentColor" stroke-width="1" stroke-linecap="round" />
            </svg>
          </button>
          <!-- 黄色 - 最小化 -->
          <button class="titlebar-dot minimize-dot" id="minimize-btn" title="最小化">
            <svg width="6" height="6" viewBox="0 0 6 6" class="dot-icon">
              <path d="M1,3 L5,3" stroke="currentColor" stroke-width="1" stroke-linecap="round" />
            </svg>
          </button>
          <!-- 绿色 - 全屏/最大化 -->
          <button class="titlebar-dot maximize-dot" id="maximize-btn" title="全屏">
            <svg width="6" height="6" viewBox="0 0 6 6" class="dot-icon">
              <path d="M1,1 L5,1 L5,5 L1,5 Z" stroke="none" fill="currentColor" />
              <path d="M2.5,2 L3.5,2 M3.5,2 L3.5,4 M3.5,4 L2.5,4" stroke="currentColor" stroke-width="0.8" fill="none" stroke-linecap="round" />
            </svg>
          </button>
        </div>
        <div class="titlebar-drag-region">
          <div class="titlebar-title">Toolkit Studio</div>
        </div>
      </div>
    </div>

    <div class="app-container">
      <!-- Main App Content -->
      <div class="app-main">
        <!-- Sidebar Navigation - 动态加载占位符 -->
        <div id="sidebar-container"></div>

        <!-- Main Content Area -->
        <main class="main-content">
          <!-- Pages - 动态加载占位符 -->
          <div id="project-page-container"></div>
          <div id="testcase-page-container"></div>
          <div id="device-page-container"></div>
          <div id="insights-page-container"></div>
          <div id="log-page-container"></div>
          <div id="settings-page-container"></div>
        </main>
      </div>

      <!-- Status Bar - 动态加载占位符 -->
      <div id="status-bar-container"></div>
    </div>

    <!-- 通用模态框 - 动态加载 -->
    <div id="commonModalsContainer"></div>

    <!-- 更新弹窗 - 动态加载 -->
    <div id="updateModalContainer"></div>

    <!-- 定义组件加载函数,但不立即执行 -->
    <script>
      // Electron 应用中使用 Node.js fs 模块同步加载 HTML 组件
      const fs = require("fs");
      const path = require("path");

      // 加载并插入组件
      function loadComponentIntoContainer(relativePath, containerId) {
        try {
          const fullPath = path.join(__dirname, relativePath);
          const html = fs.readFileSync(fullPath, "utf8");
          const container = document.getElementById(containerId);
          if (container) {
            container.outerHTML = html;
          } else {
            console.error(`Container not found: ${containerId}`);
          }
        } catch (error) {
          console.error(`Failed to load component: ${relativePath}`, error);
        }
      }

      // 在 DOMContentLoaded 之前同步加载所有组件
      // 这样可以确保 DOM 在任何脚本初始化之前就完整了
      (function() {
        try {
          loadComponentIntoContainer("components/sidebar.html", "sidebar-container");
          loadComponentIntoContainer("pages/project.html", "project-page-container");
          loadComponentIntoContainer("pages/testcase.html", "testcase-page-container");
          loadComponentIntoContainer("pages/device.html", "device-page-container");
          loadComponentIntoContainer("pages/insights.html", "insights-page-container");
          loadComponentIntoContainer("pages/log.html", "log-page-container");
          loadComponentIntoContainer("pages/settings.html", "settings-page-container");
          loadComponentIntoContainer("components/status-bar.html", "status-bar-container");
          loadComponentIntoContainer("modals/update-modal.html", "updateModalContainer");
          console.log("✓ 所有 HTML 组件已同步加载完成");
        } catch (error) {
          console.error("❌ 组件加载失败:", error);
          throw error;
        }
      })();

      // Save Node require
      window.nodeRequire = require;

      // ============================================================
      // 核心全局变量 AppGlobals - 内联加载
      // 注意：必须内联加载而不是外部文件，因为在 Electron 中
      // 外部 <script src> 标签加载的文件在某些情况下不会执行
      // ============================================================
      (function() {
        // 测试：立即设置一个全局标记
        window.__GLOBALS_JS_LOADING__ = true;

        const electron = window.nodeRequire ? window.nodeRequire('electron') : require('electron');
        const { ipcRenderer } = electron;

        // 发送日志的辅助函数（在 renderer-logger 加载之前使用）
        function sendLog(level, message) {
          try {
            ipcRenderer.send('renderer-log', {
              level: level,
              message: message,
              timestamp: new Date().toISOString()
            });
          } catch (e) {
            // 静默失败
          }
        }

        sendLog('info', '[globals.js-inline] 开始执行');

        const path = window.nodeRequire ? window.nodeRequire('path') : require('path');
        const fs = (window.nodeRequire ? window.nodeRequire('fs') : require('fs')).promises;
        const fsSync = window.nodeRequire ? window.nodeRequire('fs') : require('fs');

        // 可选依赖 - 如果加载失败不应该阻止整个应用
        let yaml = null;
        let parse = null;

        try {
          yaml = window.nodeRequire ? window.nodeRequire('js-yaml') : require('js-yaml');
          sendLog('info', '[globals.js-inline] js-yaml 加载成功');
        } catch (error) {
          sendLog('warn', '[globals.js-inline] js-yaml 模块加载失败: ' + error.message);
        }

        try {
          const csvParse = window.nodeRequire ? window.nodeRequire('csv-parse/sync') : require('csv-parse/sync');
          parse = csvParse.parse;
          sendLog('info', '[globals.js-inline] csv-parse 加载成功');
        } catch (error) {
          sendLog('warn', '[globals.js-inline] csv-parse 模块加载失败: ' + error.message);
        }

        // 全局变量
        let currentProject = null;
        let currentCase = null;
        let currentTab = null;
        let codeEditor = null;
        let lineNumbers = null;
        let syntaxHighlight = null;
        let openTabs = [];
        let deviceScreenInterval = null;

        sendLog('info', '[globals.js-inline] 准备创建 AppGlobals');

        // 导出全局变量和模块
        window.AppGlobals = {
          electron,
          ipcRenderer,
          path,
          fs,
          fsSync,
          yaml,
          parse,
          currentProject,
          currentCase,
          currentTab,
          codeEditor,
          lineNumbers,
          syntaxHighlight,
          openTabs,
          deviceScreenInterval,

          // 设置器函数
          setCurrentProject: (project) => {
            currentProject = project;
            window.AppGlobals.currentProject = project;
            if (window.rLog) {
              window.rLog(`✅ 项目路径已更新: ${project}`);
            }

            // 触发项目变更事件
            document.dispatchEvent(new CustomEvent('project-changed', { detail: { projectPath: project } }));

            // 同时更新状态栏显示
            if (window.StatusBarModule) {
              window.StatusBarModule.updateProjectPath(project);
            }
          },
          setCurrentCase: (testCase) => { currentCase = testCase; window.AppGlobals.currentCase = testCase; },
          setCurrentTab: (tab) => { currentTab = tab; window.AppGlobals.currentTab = tab; },
          setCodeEditor: (editor) => { codeEditor = editor; window.AppGlobals.codeEditor = editor; },
          setLineNumbers: (ln) => { lineNumbers = ln; window.AppGlobals.lineNumbers = ln; },
          setSyntaxHighlight: (sh) => { syntaxHighlight = sh; window.AppGlobals.syntaxHighlight = sh; },
          setOpenTabs: (tabs) => { openTabs = tabs; window.AppGlobals.openTabs = tabs; },
          setDeviceScreenInterval: (interval) => { deviceScreenInterval = interval; window.AppGlobals.deviceScreenInterval = interval; },

          // 统一的项目路径获取函数
          getCurrentProjectPath: () => {
            const projectPath = window.AppGlobals.currentProject;
            if (!projectPath && window.rWarn) {
              window.rWarn('⚠️  当前没有打开的项目，请先在Project页面打开或创建一个项目');
            }
            return projectPath;
          }
        };

        sendLog('info', '[globals.js-inline] AppGlobals 创建成功: ' + typeof window.AppGlobals);
      })();
    </script>

    <!-- Utils -->
    <script src="../js/utils/execution-output.js"></script>
    <script src="../js/utils/app-notifications.js"></script>
    <!-- 图像匹配功能已集成到TKE适配器中 -->
    <script src="../js/device/wda-controller.js"></script>
    <!-- 旧 Editor 模块已完全替换为 CodeJar，现在通过 app.js 动态加载 -->
    <!-- Testcase Runner -->
    <script src="../js/testcase/runner/script-runner.js"></script>
    <!-- Testcase Panels -->
    <script src="../js/testcase/panels/bottom-panel-manager.js"></script>
    <script src="../js/testcase/panels/elements-list-panel.js"></script>
    <script src="../js/testcase/panels/element-properties-panel.js"></script>
    <script src="../js/testcase/panels/locator-library-panel.js"></script>
    <script src="../js/testcase/panels/console-panel.js"></script>
    <script src="../js/components/custom-titlebar.js"></script>
    <script src="../js/utils/component-loader.js"></script>
    <script src="../js/updater/update-modal.js"></script>
    <script src="../js/app.js"></script>
  </body>
</html>
